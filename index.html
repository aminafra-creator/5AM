<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Dawn">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f172a">
  <meta name="description" content="Dawn ‚Äî Join the 5am Club. Shift your wake time in 18 days.">
  
  <link rel="manifest" href="dawn-manifest.json">
  <link rel="apple-touch-icon" href="dawn-icon-192.png">
  
  <title>Dawn ‚Äî 5am Club</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    :root {
      /* Night Mode (Default) */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --bg-card: rgba(30, 41, 59, 0.7);
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --amber: #f59e0b;
      --amber-soft: rgba(245, 158, 11, 0.15);
      --orange: #f97316;
      --green: #22c55e;
      --green-soft: rgba(34, 197, 94, 0.15);
      --indigo: #6366f1;
      --indigo-soft: rgba(99, 102, 241, 0.15);
      --blue: #3b82f6;
      --red: #ef4444;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      
      /* Font sizes - LARGER */
      --font-xs: 13px;
      --font-sm: 14px;
      --font-base: 16px;
      --font-lg: 18px;
      --font-xl: 22px;
      --font-2xl: 28px;
      --font-3xl: 36px;
    }
    
    /* Day Mode Theme */
    body.day-mode {
      --bg-primary: #f8fafc;
      --bg-secondary: #e2e8f0;
      --bg-tertiary: #cbd5e1;
      --bg-card: rgba(255, 255, 255, 0.9);
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --amber-soft: rgba(245, 158, 11, 0.12);
      --green-soft: rgba(34, 197, 94, 0.12);
      --indigo-soft: rgba(99, 102, 241, 0.12);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      padding: calc(var(--safe-top) + 16px) 16px calc(var(--safe-bottom) + 90px) 16px;
      overflow-x: hidden;
      font-size: var(--font-base);
      line-height: 1.5;
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    .container { max-width: 480px; margin: 0 auto; }
    
    /* Header */
    .header { text-align: center; margin-bottom: 20px; }
    .header h1 {
      font-size: var(--font-3xl);
      font-weight: 700;
      background: linear-gradient(135deg, var(--amber), var(--orange));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header .tagline { color: var(--text-muted); font-size: var(--font-base); margin-top: 4px; }
    
    /* Theme Toggle */
    .theme-toggle {
      position: absolute;
      top: calc(var(--safe-top) + 16px);
      right: 16px;
      background: var(--bg-card);
      border: 1px solid var(--bg-tertiary);
      border-radius: 50px;
      padding: 8px 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: var(--font-sm);
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }
    
    .theme-toggle:active { transform: scale(0.95); }
    .theme-toggle .icon { font-size: 18px; }
    
    /* Cards */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(51, 65, 85, 0.4);
      transition: background 0.3s ease, border 0.3s ease;
    }
    
    body.day-mode .card {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .card-label {
      font-size: var(--font-xs);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card-label .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    
    .dot.amber { background: var(--amber); }
    .dot.green { background: var(--green); }
    .dot.indigo { background: var(--indigo); }
    .dot.blue { background: var(--blue); }
    
    /* Phase Banner */
    .phase-banner {
      background: var(--amber-soft);
      border: 1px solid rgba(245, 158, 11, 0.25);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .phase-info h2 {
      font-size: var(--font-xl);
      font-weight: 700;
      color: var(--amber);
    }
    
    .phase-info p {
      font-size: var(--font-sm);
      color: var(--text-secondary);
      margin-top: 2px;
    }
    
    .streak-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(245, 158, 11, 0.2);
      padding: 10px 16px;
      border-radius: 20px;
      font-size: var(--font-base);
      font-weight: 600;
      color: var(--orange);
    }
    
    /* Time Targets */
    .time-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    
    .time-box {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }
    
    body.day-mode .time-box {
      background: var(--bg-secondary);
    }
    
    .time-box .icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .time-box .label {
      font-size: var(--font-xs);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .time-box .time {
      font-size: var(--font-2xl);
      font-weight: 700;
      margin-top: 6px;
    }
    
    .time-box.wake .time { color: var(--amber); }
    .time-box.bed .time { color: var(--indigo); }
    
    /* Progress Ring */
    .progress-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .progress-text h3 {
      font-size: var(--font-3xl);
      font-weight: 700;
    }
    
    .progress-text p {
      font-size: var(--font-sm);
      color: var(--text-muted);
    }
    
    .ring-container {
      position: relative;
      width: 100px;
      height: 100px;
    }
    
    .ring-container svg { transform: rotate(-90deg); }
    .ring-bg { stroke: var(--bg-tertiary); }
    .ring-fg { 
      stroke: url(#ringGradient); 
      stroke-linecap: round; 
      transition: stroke-dasharray 0.5s ease; 
    }
    
    .ring-percent {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xl);
      font-weight: 700;
    }
    
    /* Alert */
    .alert {
      border-radius: 14px;
      padding: 18px;
      display: flex;
      gap: 14px;
      align-items: flex-start;
    }
    
    .alert.morning { background: var(--amber-soft); border: 1px solid rgba(245, 158, 11, 0.25); }
    .alert.afternoon { background: rgba(59, 130, 246, 0.12); border: 1px solid rgba(59, 130, 246, 0.25); }
    .alert.evening { background: var(--indigo-soft); border: 1px solid rgba(99, 102, 241, 0.25); }
    
    .alert-icon { font-size: 28px; }
    .alert-content h3 { font-size: var(--font-lg); font-weight: 600; }
    .alert-content p { font-size: var(--font-sm); color: var(--text-secondary); margin-top: 6px; line-height: 1.5; }
    
    /* Habit Grid */
    .habit-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .habit-btn {
      background: var(--bg-tertiary);
      border: 2px solid transparent;
      border-radius: 14px;
      padding: 18px 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .habit-btn:active { transform: scale(0.95); }
    .habit-btn.done { background: var(--green-soft); border-color: var(--green); }
    
    .habit-btn .icon { font-size: 28px; }
    .habit-btn .label { font-size: var(--font-xs); color: var(--text-secondary); text-align: center; }
    .habit-btn.done .label { color: var(--green); }
    
    /* Ratings */
    .rating-row {
      margin-bottom: 18px;
    }
    
    .rating-row:last-child { margin-bottom: 0; }
    
    .rating-label {
      font-size: var(--font-sm);
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    
    .rating-buttons {
      display: flex;
      gap: 6px;
    }
    
    .rating-btn {
      flex: 1;
      padding: 14px 0;
      background: var(--bg-tertiary);
      border: none;
      border-radius: 8px;
      color: var(--text-primary);
      font-size: var(--font-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .rating-btn:active { transform: scale(0.9); }
    .rating-btn.active.sleep { background: var(--indigo); }
    .rating-btn.active.energy { background: var(--amber); }
    
    /* Complete Button */
    .day-summary-card {
      border: 2px solid var(--amber-soft);
    }
    
    .day-checklist {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 18px;
    }
    
    .checklist-item {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: var(--font-base);
      color: var(--text-muted);
    }
    
    .checklist-item.done {
      color: var(--green);
    }
    
    .check-icon {
      font-size: 20px;
      width: 24px;
      text-align: center;
    }
    
    .checklist-item.done .check-icon {
      color: var(--green);
    }
    
    .complete-btn {
      width: 100%;
      padding: 20px;
      background: linear-gradient(135deg, var(--green), #10b981);
      border: none;
      border-radius: 16px;
      color: white;
      font-size: var(--font-lg);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s ease;
    }
    
    .complete-btn:active { transform: scale(0.98); }
    .complete-btn:disabled { 
      opacity: 0.4; 
      pointer-events: none;
      background: var(--bg-tertiary);
    }
    
    .btn-arrow {
      font-size: var(--font-xl);
      transition: transform 0.2s ease;
    }
    
    .complete-btn:not(:disabled):hover .btn-arrow {
      transform: translateX(4px);
    }
    
    .complete-hint {
      text-align: center;
      font-size: var(--font-sm);
      color: var(--text-muted);
      margin-top: 12px;
    }
    
    .complete-hint.ready {
      color: var(--green);
    }
    
    /* Phase Timeline */
    .phase-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 10px;
    }
    
    .phase-item.current { background: var(--amber-soft); }
    
    .phase-num {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: var(--font-lg);
      flex-shrink: 0;
    }
    
    .phase-item.complete .phase-num { background: var(--green); }
    .phase-item.current .phase-num { background: var(--amber); color: var(--bg-primary); }
    
    .phase-details { flex: 1; }
    .phase-details h4 { font-size: var(--font-base); font-weight: 600; }
    .phase-details p { font-size: var(--font-sm); color: var(--text-muted); }
    
    .phase-badge {
      font-size: var(--font-xs);
      background: var(--amber);
      color: var(--bg-primary);
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 700;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
    }
    
    .stat-box {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 14px;
      padding: 20px;
      text-align: center;
    }
    
    body.day-mode .stat-box {
      background: var(--bg-secondary);
    }
    
    .stat-value {
      font-size: var(--font-2xl);
      font-weight: 700;
    }
    
    .stat-value.amber { color: var(--amber); }
    .stat-value.green { color: var(--green); }
    .stat-value.indigo { color: var(--indigo); }
    .stat-value.orange { color: var(--orange); }
    
    .stat-label {
      font-size: var(--font-xs);
      color: var(--text-muted);
      margin-top: 6px;
    }
    
    /* Log History */
    .log-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .log-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    
    .log-item:active { transform: scale(0.98); }
    
    .log-date {
      flex: 1;
    }
    
    .log-date strong {
      display: block;
      font-size: var(--font-base);
      font-weight: 600;
    }
    
    .log-date span {
      font-size: var(--font-sm);
      color: var(--text-muted);
    }
    
    .log-stats {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .log-stat {
      text-align: center;
    }
    
    .log-stat .value {
      font-size: var(--font-lg);
      font-weight: 700;
      color: var(--amber);
    }
    
    .log-stat .label {
      font-size: var(--font-xs);
      color: var(--text-muted);
    }
    
    .log-actions {
      display: flex;
      gap: 8px;
    }
    
    .log-action-btn {
      background: var(--bg-secondary);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .log-action-btn:active { transform: scale(0.9); }
    .log-action-btn.delete { background: rgba(239, 68, 68, 0.15); }
    
    /* Edit Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    
    .modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    
    .modal {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 24px;
      width: calc(100% - 32px);
      max-width: 400px;
      transform: translateY(20px);
      transition: transform 0.2s ease;
    }
    
    .modal-overlay.show .modal {
      transform: translateY(0);
    }
    
    .modal h3 {
      font-size: var(--font-xl);
      margin-bottom: 20px;
      text-align: center;
    }
    
    .modal-field {
      margin-bottom: 16px;
    }
    
    .modal-field label {
      display: block;
      font-size: var(--font-sm);
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    
    .modal-field input, .modal-field select {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: var(--font-base);
      font-family: inherit;
    }
    
    .modal-field input:focus, .modal-field select:focus {
      outline: none;
      border-color: var(--amber);
    }
    
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: var(--font-base);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .modal-btn:active { transform: scale(0.95); }
    
    .modal-btn.cancel {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .modal-btn.save {
      background: var(--amber);
      color: var(--bg-primary);
    }
    
    .modal-btn.delete {
      background: var(--red);
      color: white;
    }
    
    /* Export Section */
    .export-buttons {
      display: flex;
      gap: 12px;
    }
    
    .export-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 20px 14px;
      border: none;
      border-radius: 14px;
      font-family: inherit;
      font-size: var(--font-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .export-btn:active { transform: scale(0.95); }
    .export-btn .icon { font-size: 28px; }
    
    .export-btn.whatsapp { background: #25D366; color: white; }
    .export-btn.email { background: var(--indigo); color: white; }
    .export-btn.download { background: var(--bg-tertiary); color: var(--text-primary); }
    
    .download-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    
    .download-btn {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 18px;
      background: var(--bg-tertiary);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
    }
    
    .download-btn:active { transform: scale(0.98); background: var(--bg-secondary); }
    .download-btn .icon { font-size: 32px; }
    .download-btn .info strong { display: block; font-size: var(--font-base); color: var(--text-primary); }
    .download-btn .info span { font-size: var(--font-sm); color: var(--text-muted); }
    
    /* Navigation */
    .nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(51, 65, 85, 0.4);
      display: flex;
      justify-content: space-around;
      padding: 14px 16px calc(var(--safe-bottom) + 14px) 16px;
      transition: background 0.3s ease;
    }
    
    body.day-mode .nav {
      background: rgba(248, 250, 252, 0.95);
      border-top-color: rgba(203, 213, 225, 0.5);
    }
    
    .nav-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      padding: 10px 18px;
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    
    .nav-btn.active { color: var(--amber); background: var(--amber-soft); }
    .nav-btn .icon { font-size: 24px; }
    .nav-btn span { font-size: var(--font-xs); font-weight: 500; }
    
    /* Sections */
    .section { display: none; }
    .section.active { display: block; }
    
    /* Advanced Section */
    .card-subtitle {
      font-size: var(--font-sm);
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    
    /* Gratitude Journal */
    .journal-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .journal-tab {
      flex: 1;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 2px solid transparent;
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: var(--font-base);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .journal-tab.active {
      background: var(--amber-soft);
      color: var(--amber);
      border-color: var(--amber);
    }
    
    .journal-prompt {
      font-size: var(--font-base);
      color: var(--text-primary);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .journal-hint {
      font-size: var(--font-sm);
      color: var(--amber);
      margin-bottom: 16px;
      font-style: italic;
    }
    
    .gratitude-entries {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .gratitude-entry {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    
    .entry-num {
      width: 28px;
      height: 28px;
      background: var(--amber-soft);
      color: var(--amber);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: var(--font-sm);
      flex-shrink: 0;
      margin-top: 8px;
    }
    
    .gratitude-entry textarea {
      flex: 1;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 2px solid transparent;
      border-radius: 12px;
      color: var(--text-primary);
      font-size: var(--font-base);
      font-family: inherit;
      resize: none;
      transition: all 0.2s ease;
    }
    
    .gratitude-entry textarea:focus {
      outline: none;
      border-color: var(--amber);
    }
    
    body.day-mode .gratitude-entry textarea {
      background: var(--bg-secondary);
    }
    
    .save-journal-btn {
      width: 100%;
      padding: 14px;
      background: var(--amber);
      border: none;
      border-radius: 12px;
      color: var(--bg-primary);
      font-size: var(--font-base);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .save-journal-btn:active { transform: scale(0.98); }
    
    /* Advanced Habits Grid */
    .advanced-habits-grid {
      display: grid;
      gap: 10px;
    }
    
    .advanced-habit {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .advanced-habit.done {
      background: var(--green-soft);
    }
    
    .advanced-habit .habit-check {
      width: 26px;
      height: 26px;
      border: 2px solid var(--text-muted);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .advanced-habit.done .habit-check {
      background: var(--green);
      border-color: var(--green);
      color: white;
    }
    
    .advanced-habit .habit-content {
      flex: 1;
    }
    
    .advanced-habit .habit-name {
      font-size: var(--font-base);
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .advanced-habit .habit-desc {
      font-size: var(--font-xs);
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    .advanced-habit .habit-info-btn {
      width: 28px;
      height: 28px;
      background: var(--bg-secondary);
      border: none;
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Protocol Card */
    .protocol-card .protocol-content {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 16px;
    }
    
    .protocol-step {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    
    .step-num {
      width: 28px;
      height: 28px;
      background: var(--red);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: var(--font-sm);
      flex-shrink: 0;
    }
    
    .step-content strong {
      display: block;
      font-size: var(--font-base);
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    
    .step-content p {
      font-size: var(--font-sm);
      color: var(--text-muted);
      line-height: 1.4;
    }
    
    .protocol-link {
      display: inline-block;
      margin-top: 8px;
      padding: 8px 14px;
      background: var(--indigo-soft);
      color: var(--indigo);
      border-radius: 8px;
      font-size: var(--font-sm);
      font-weight: 600;
      text-decoration: none;
    }
    
    .science-citation {
      padding: 14px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      font-size: var(--font-sm);
      color: var(--text-secondary);
      line-height: 1.6;
      border-left: 3px solid var(--indigo);
    }
    
    .science-citation strong {
      color: var(--indigo);
    }
    
    /* Science Topics */
    .science-topics {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .science-topic-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--bg-tertiary);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
    }
    
    .science-topic-btn:active {
      transform: scale(0.98);
    }
    
    .topic-icon {
      font-size: 22px;
    }
    
    .topic-text {
      flex: 1;
      font-size: var(--font-base);
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .topic-arrow {
      color: var(--text-muted);
      font-size: 18px;
    }
    
    .sources-text {
      font-size: var(--font-sm);
      color: var(--text-muted);
      line-height: 1.6;
    }
    
    .sources-text strong {
      color: var(--text-secondary);
    }
    
    /* Science Modal */
    .science-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-radius: 24px 24px 0 0;
      padding: 24px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 400;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    
    .science-modal.show {
      transform: translateY(0);
    }
    
    .science-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 350;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .science-modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    
    .science-modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .science-modal-icon {
      font-size: 32px;
    }
    
    .science-modal-title {
      font-size: var(--font-xl);
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .science-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      background: var(--bg-tertiary);
      border: none;
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
    }
    
    .science-modal-body {
      font-size: var(--font-base);
      color: var(--text-secondary);
      line-height: 1.7;
    }
    
    .science-modal-body h4 {
      color: var(--text-primary);
      font-size: var(--font-lg);
      margin: 20px 0 10px 0;
    }
    
    .science-modal-body h4:first-child {
      margin-top: 0;
    }
    
    .science-modal-body ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .science-modal-body li {
      margin-bottom: 8px;
    }
    
    .science-modal-body .source {
      display: inline-block;
      margin-top: 16px;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: var(--font-sm);
      color: var(--text-muted);
    }
    
    .science-modal-body .source strong {
      color: var(--amber);
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 110px;
      left: 50%;
      transform: translateX(-50%) translateY(50px);
      background: var(--bg-secondary);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 50px;
      padding: 14px 28px;
      font-size: var(--font-base);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 300;
    }
    
    body.day-mode .toast {
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    
    /* Install Banner */
    .install-banner {
      position: fixed;
      bottom: 95px;
      left: 16px;
      right: 16px;
      background: var(--amber);
      color: var(--bg-primary);
      border-radius: 16px;
      padding: 16px 18px;
      display: flex;
      align-items: center;
      gap: 14px;
      z-index: 200;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    
    .install-banner.hidden { display: none; }
    .install-banner .icon { font-size: 32px; }
    .install-banner .text { flex: 1; }
    .install-banner .text strong { display: block; font-size: var(--font-base); }
    .install-banner .text span { font-size: var(--font-sm); opacity: 0.8; }
    
    .install-banner .btn {
      background: var(--bg-primary);
      border: none;
      padding: 12px 18px;
      border-radius: 10px;
      color: var(--amber);
      font-size: var(--font-sm);
      font-weight: 600;
      cursor: pointer;
    }
    
    .install-banner .close {
      background: none;
      border: none;
      color: var(--bg-primary);
      font-size: 24px;
      cursor: pointer;
      opacity: 0.6;
      padding: 4px;
    }
    
    /* Hidden */
    .hidden { display: none !important; }
    
    /* Science Tips */
    .tips-content {
      font-size: var(--font-base);
      color: var(--text-secondary);
      line-height: 1.7;
    }
    
    .tips-content p {
      margin-bottom: 16px;
    }
    
    .tips-content p:last-child {
      margin-bottom: 0;
    }
    
    .tips-content strong {
      color: var(--text-primary);
    }
    
    /* Wake Time Input */
    .wake-input-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .wake-input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    
    .wake-field {
      flex: 1;
    }
    
    .wake-field label {
      display: block;
      font-size: var(--font-base);
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .wake-hint {
      display: block;
      font-size: var(--font-xs);
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    .time-input {
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 2px solid transparent;
      border-radius: 12px;
      color: var(--text-primary);
      font-size: var(--font-lg);
      font-weight: 700;
      font-family: inherit;
      text-align: center;
      min-width: 120px;
      transition: all 0.2s ease;
    }
    
    .time-input:focus {
      outline: none;
      border-color: var(--amber);
    }
    
    body.day-mode .time-input {
      background: var(--bg-secondary);
    }
    
    .wake-comparison {
      padding: 16px 18px;
      border-radius: 12px;
      font-size: var(--font-base);
      text-align: center;
      font-weight: 500;
      line-height: 1.6;
    }
    
    .wake-comparison.on-target {
      background: var(--green-soft);
      color: var(--green);
    }
    
    .wake-comparison.early {
      background: var(--green-soft);
      color: var(--green);
    }
    
    .wake-comparison.late {
      background: rgba(239, 68, 68, 0.15);
      color: var(--red);
    }
    
    .wake-comparison.empty {
      background: var(--bg-tertiary);
      color: var(--text-muted);
    }
    
    .wake-comparison .snooze-time {
      display: block;
      margin-top: 8px;
      font-size: var(--font-sm);
      opacity: 0.85;
    }
    
    /* Bedtime Input */
    .bed-input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--bg-tertiary);
    }
  </style>
</head>
<body>
  <!-- Install Banner -->
  <div class="install-banner hidden" id="install-banner">
    <span class="icon">‚òÄÔ∏è</span>
    <div class="text">
      <strong>Install Dawn</strong>
      <span>Add to home screen</span>
    </div>
    <button class="btn" id="install-btn">Install</button>
    <button class="close" id="install-close">√ó</button>
  </div>
  
  <!-- Theme Toggle -->
  <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()">
    <span class="icon" id="theme-icon">‚òÄÔ∏è</span>
    <span id="theme-label">Day</span>
  </button>

  <div class="container">
    <div class="header">
      <h1>Dawn</h1>
      <p class="tagline">Join the 5am Club ‚Ä¢ 15 Day Journey</p>
    </div>
    
    <!-- TODAY SECTION -->
    <div id="today-section" class="section active">
      <!-- Phase Banner -->
      <div class="phase-banner">
        <div class="phase-info">
          <h2 id="phase-title">Day 1 ‚Ä¢ Phase 1</h2>
          <p id="phase-subtitle">8:00 AM ‚Üí 5:00 AM</p>
        </div>
        <div class="streak-badge">
          <span>üî•</span>
          <span id="streak-count">0</span>
        </div>
      </div>
      
      <!-- Time Targets -->
      <div class="card">
        <div class="card-label"><div class="dot amber"></div>Today's Targets</div>
        <div class="time-grid">
          <div class="time-box wake">
            <div class="icon">‚òÄÔ∏è</div>
            <div class="label">Target Wake</div>
            <div class="time" id="target-wake">8:00 AM</div>
          </div>
          <div class="time-box bed">
            <div class="icon">üåô</div>
            <div class="label">Target Bed</div>
            <div class="time" id="target-bed">12:00 AM</div>
          </div>
        </div>
      </div>
      
      <!-- Actual Wake Time -->
      <div class="card">
        <div class="card-label"><div class="dot green"></div>Log Your Morning</div>
        <div class="wake-input-section">
          <div class="wake-input-row">
            <div class="wake-field">
              <label>Woke up at:</label>
              <span class="wake-hint">When you first opened your eyes</span>
            </div>
            <input type="time" id="actual-wake-time" class="time-input">
          </div>
          <div class="wake-input-row">
            <div class="wake-field">
              <label>Got out of bed:</label>
              <span class="wake-hint">When you actually got up</span>
            </div>
            <input type="time" id="out-of-bed-time" class="time-input">
          </div>
          <div class="wake-comparison" id="wake-comparison"></div>
        </div>
      </div>
      
      <!-- Alert -->
      <div class="card alert morning" id="time-alert">
        <span class="alert-icon" id="alert-icon">‚òÄÔ∏è</span>
        <div class="alert-content">
          <h3 id="alert-title">Morning Priority</h3>
          <p id="alert-text">Get bright light NOW. This is the #1 factor for shifting your rhythm.</p>
        </div>
      </div>
      
      <!-- Progress -->
      <div class="card">
        <div class="card-label"><div class="dot green"></div>Today's Progress</div>
        <div class="progress-section">
          <div class="progress-text">
            <h3><span id="completed-count">0</span>/9</h3>
            <p>habits completed</p>
          </div>
          <div class="ring-container">
            <svg width="100" height="100" viewBox="0 0 100 100">
              <defs>
                <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#f59e0b"/>
                  <stop offset="100%" stop-color="#f97316"/>
                </linearGradient>
              </defs>
              <circle class="ring-bg" cx="50" cy="50" r="42" fill="none" stroke-width="8"/>
              <circle class="ring-fg" id="progress-ring" cx="50" cy="50" r="42" fill="none" stroke-width="8" stroke-dasharray="0 264"/>
            </svg>
            <div class="ring-percent"><span id="daily-percent">0</span>%</div>
          </div>
        </div>
      </div>
      
      <!-- Quick Habits -->
      <div class="card">
        <div class="card-label"><div class="dot amber"></div>Quick Check</div>
        <div class="habit-grid" id="habit-grid"></div>
      </div>
      
      <!-- Ratings -->
      <div class="card">
        <div class="card-label"><div class="dot indigo"></div>Rate Today</div>
        <div class="rating-row">
          <div class="rating-label">Sleep Quality (1-10)</div>
          <div class="rating-buttons" id="sleep-rating"></div>
        </div>
        <div class="rating-row">
          <div class="rating-label">Energy Level (1-10)</div>
          <div class="rating-buttons" id="energy-rating"></div>
        </div>
      </div>
      
      <!-- Day Summary & Complete -->
      <div class="card day-summary-card">
        <div class="card-label"><div class="dot amber"></div>Day <span id="summary-day-num">1</span> Progress</div>
        <div class="day-checklist">
          <div class="checklist-item" id="check-wake">
            <span class="check-icon">‚óã</span>
            <span class="check-text">Log wake time</span>
          </div>
          <div class="checklist-item" id="check-outofbed">
            <span class="check-icon">‚óã</span>
            <span class="check-text">Log out-of-bed time</span>
          </div>
          <div class="checklist-item" id="check-habits">
            <span class="check-icon">‚óã</span>
            <span class="check-text">Complete 70% habits (<span id="habits-progress">0</span>/9)</span>
          </div>
        </div>
        <button class="complete-btn" id="complete-btn" disabled>
          <span id="complete-btn-text">Finish Day 1</span>
          <span class="btn-arrow">‚Üí</span>
        </button>
        <p class="complete-hint" id="complete-hint">Complete the checklist above to unlock</p>
      </div>
    </div>
    
    <!-- JOURNEY SECTION -->
    <div id="journey-section" class="section">
      <div class="card">
        <div class="card-label"><div class="dot amber"></div>Your 15-Day Journey</div>
        <div class="phase-timeline" id="phase-timeline"></div>
      </div>
      
      <div class="card">
        <div class="card-label"><div class="dot green"></div>Your Stats</div>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value amber" id="stat-streak">0</div>
            <div class="stat-label">Day Streak</div>
          </div>
          <div class="stat-box">
            <div class="stat-value green" id="stat-days">0</div>
            <div class="stat-label">Days Logged</div>
          </div>
          <div class="stat-box">
            <div class="stat-value indigo" id="stat-phase">1/5</div>
            <div class="stat-label">Current Phase</div>
          </div>
          <div class="stat-box">
            <div class="stat-value orange" id="stat-shifted">0m</div>
            <div class="stat-label">Time Shifted</div>
          </div>
        </div>
      </div>
      
      <!-- Log History -->
      <div class="card">
        <div class="card-label"><div class="dot indigo"></div>Log History (Tap to Edit)</div>
        <div class="log-list" id="log-list">
          <p style="color: var(--text-muted); text-align: center; padding: 20px;">No logs yet. Complete your first day!</p>
        </div>
      </div>
      
      <div class="card">
        <div class="card-label"><div class="dot blue"></div>Science Tips</div>
        <div class="tips-content">
          <p><strong style="color: var(--amber);">‚òÄÔ∏è Light is #1:</strong> 30+ min morning light shifts your clock more than anything else.</p>
          <p><strong style="color: var(--indigo);">üåô Darkness matters:</strong> Evening light pushes your clock later. Dim everything 90min before bed.</p>
          <p><strong style="color: var(--green);">üìÖ Consistency:</strong> Same wake time daily‚Äîweekends included. One sleep-in sets you back days.</p>
          <p><strong style="color: var(--blue);">‚òï Caffeine cutoff:</strong> No coffee after 2 PM. Caffeine has a 6-hour half-life.</p>
        </div>
      </div>
    </div>
    
    <!-- ADVANCED SECTION -->
    <div id="advanced-section" class="section">
      <!-- Gratitude Journal -->
      <div class="card">
        <div class="card-label"><div class="dot amber"></div>Gratitude Journal</div>
        <p class="card-subtitle">3 minutes morning & evening ‚Äî proven to improve sleep quality</p>
        
        <div class="journal-tabs" id="journal-tabs">
          <button class="journal-tab" id="morning-tab" onclick="showJournalTab('morning')">‚òÄÔ∏è Morning</button>
          <button class="journal-tab" id="evening-tab" onclick="showJournalTab('evening')">üåô Evening</button>
        </div>
        
        <div id="morning-journal" class="journal-content">
          <p class="journal-prompt">What are 3 specific things you're grateful for this morning?</p>
          <p class="journal-hint">Be specific! Not "my family" but "my daughter's laugh when I tickled her last night"</p>
          <div class="gratitude-entries">
            <div class="gratitude-entry">
              <span class="entry-num">1</span>
              <textarea id="morning-gratitude-1" placeholder="e.g., The warm coffee my wife made me before I woke up" rows="2"></textarea>
            </div>
            <div class="gratitude-entry">
              <span class="entry-num">2</span>
              <textarea id="morning-gratitude-2" placeholder="e.g., Getting 7 hours of sleep last night" rows="2"></textarea>
            </div>
            <div class="gratitude-entry">
              <span class="entry-num">3</span>
              <textarea id="morning-gratitude-3" placeholder="e.g., The quiet sunrise view from my balcony" rows="2"></textarea>
            </div>
          </div>
          <button class="save-journal-btn" onclick="saveJournal('morning')">Save Morning Journal</button>
        </div>
        
        <div id="evening-journal" class="journal-content" style="display: none;">
          <p class="journal-prompt">What are 3 specific things you're grateful for tonight?</p>
          <p class="journal-hint">Be specific! Not "my health" but "having energy to play football with my son after work"</p>
          <div class="gratitude-entries">
            <div class="gratitude-entry">
              <span class="entry-num">1</span>
              <textarea id="evening-gratitude-1" placeholder="e.g., My colleague who helped me finish the report on time" rows="2"></textarea>
            </div>
            <div class="gratitude-entry">
              <span class="entry-num">2</span>
              <textarea id="evening-gratitude-2" placeholder="e.g., The delicious dinner we had together as a family" rows="2"></textarea>
            </div>
            <div class="gratitude-entry">
              <span class="entry-num">3</span>
              <textarea id="evening-gratitude-3" placeholder="e.g., Learning something new in today's meeting" rows="2"></textarea>
            </div>
          </div>
          <button class="save-journal-btn" onclick="saveJournal('evening')">Save Evening Journal</button>
        </div>
      </div>
      
      <!-- Advanced Habits -->
      <div class="card">
        <div class="card-label"><div class="dot green"></div>Advanced Habits</div>
        <p class="card-subtitle">Additional protocols from Johnson, Huberman & Attia</p>
        
        <div class="advanced-habits-grid" id="advanced-habits-grid">
          <!-- Populated by JS -->
        </div>
      </div>
      
      <!-- Wake At Night Protocol -->
      <div class="card protocol-card">
        <div class="card-label"><div class="dot red"></div>If You Wake At Night</div>
        <div class="protocol-content">
          <div class="protocol-step">
            <span class="step-num">1</span>
            <div class="step-content">
              <strong>Don't check the time</strong>
              <p>Looking at the clock triggers anxiety about sleep loss</p>
            </div>
          </div>
          <div class="protocol-step">
            <span class="step-num">2</span>
            <div class="step-content">
              <strong>Stay in darkness</strong>
              <p>If you must move, use only red/orange light</p>
            </div>
          </div>
          <div class="protocol-step">
            <span class="step-num">3</span>
            <div class="step-content">
              <strong>Try NSDR (10-20 min)</strong>
              <p>Non-Sleep Deep Rest restores energy even without sleep</p>
              <a href="https://www.youtube.com/results?search_query=huberman+nsdr+10+minutes" target="_blank" class="protocol-link">üéß Find NSDR Audio</a>
            </div>
          </div>
          <div class="protocol-step">
            <span class="step-num">4</span>
            <div class="step-content">
              <strong>If awake >20 min, get up</strong>
              <p>Read in dim light until sleepy. Don't train your brain that bed = awake.</p>
            </div>
          </div>
        </div>
        <div class="science-citation">
          <strong>The Science:</strong> Huberman recommends NSDR (Yoga Nidra) for night waking. Studies show it activates parasympathetic nervous system, lowering heart rate and cortisol. Even without falling asleep, NSDR provides ~65% of the restorative benefits of actual sleep.
        </div>
      </div>
      
      <!-- Science Library -->
      <div class="card">
        <div class="card-label"><div class="dot indigo"></div>Science Library</div>
        <p class="card-subtitle">Tap any topic to learn the research behind it</p>
        
        <div class="science-topics">
          <button class="science-topic-btn" onclick="showScience('five-am-club')">
            <span class="topic-icon">üåÖ</span>
            <span class="topic-text">The Science of Waking at 5AM</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
          <button class="science-topic-btn" onclick="showScience('twenty-twenty-twenty')">
            <span class="topic-icon">‚è±Ô∏è</span>
            <span class="topic-text">The 20/20/20 Formula (Robin Sharma)</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
          <button class="science-topic-btn" onclick="showScience('morning-willpower')">
            <span class="topic-icon">üß†</span>
            <span class="topic-text">Morning Willpower & Productivity</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
          <button class="science-topic-btn" onclick="showScience('caffeine-delay')">
            <span class="topic-icon">‚òï</span>
            <span class="topic-text">Why Delay Morning Caffeine 90min?</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
          <button class="science-topic-btn" onclick="showScience('cold-exposure')">
            <span class="topic-icon">üßä</span>
            <span class="topic-text">Morning Cold Exposure</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
          <button class="science-topic-btn" onclick="showScience('evening-self')">
            <span class="topic-icon">üß†</span>
            <span class="topic-text">Evening Self Identity (Bryan Johnson)</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
          <button class="science-topic-btn" onclick="showScience('morning-light')">
            <span class="topic-icon">‚òÄÔ∏è</span>
            <span class="topic-text">Morning Light (10,000 lux)</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
          <button class="science-topic-btn" onclick="showScience('temperature')">
            <span class="topic-icon">üå°Ô∏è</span>
            <span class="topic-text">Temperature & Sleep</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
          <button class="science-topic-btn" onclick="showScience('supplements')">
            <span class="topic-icon">üíä</span>
            <span class="topic-text">Sleep Supplements Stack</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
          <button class="science-topic-btn" onclick="showScience('alcohol')">
            <span class="topic-icon">üç∑</span>
            <span class="topic-text">Alcohol & Deep Sleep</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
          <button class="science-topic-btn" onclick="showScience('gratitude')">
            <span class="topic-icon">üôè</span>
            <span class="topic-text">Gratitude & Sleep Quality</span>
            <span class="topic-arrow">‚Üí</span>
          </button>
        </div>
      </div>
      
      <!-- Sources -->
      <div class="card" style="background: var(--bg-tertiary);">
        <div class="card-label"><div class="dot"></div>Research Sources</div>
        <p class="sources-text">
          Protocols based on research from: <strong>Bryan Johnson</strong> (Blueprint), <strong>Dr. Andrew Huberman</strong> (Stanford Neuroscience), <strong>Dr. Peter Attia</strong> (Longevity Medicine), and <strong>Dr. Matthew Walker</strong> (UC Berkeley Sleep Lab).
        </p>
      </div>
    </div>
    
    <!-- SHARE SECTION -->
    <div id="share-section" class="section">
      <div class="card">
        <div class="card-label"><div class="dot green"></div>Your Progress Summary</div>
        <div class="stats-grid" style="margin-bottom: 0;">
          <div class="stat-box">
            <div class="stat-value amber" id="share-day">1</div>
            <div class="stat-label">Current Day</div>
          </div>
          <div class="stat-box">
            <div class="stat-value orange" id="share-shifted">0m</div>
            <div class="stat-label">Time Shifted</div>
          </div>
          <div class="stat-box">
            <div class="stat-value green" id="share-streak">0</div>
            <div class="stat-label">Day Streak</div>
          </div>
          <div class="stat-box">
            <div class="stat-value indigo" id="share-target">5:00</div>
            <div class="stat-label">Goal Wake</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-label"><div class="dot amber"></div>Share Your Progress</div>
        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">Send your progress report to your clinic or accountability partner</p>
        <div class="export-buttons">
          <button class="export-btn whatsapp" onclick="exportToWhatsApp()">
            <span class="icon">üí¨</span>
            WhatsApp
          </button>
          <button class="export-btn email" onclick="exportToEmail()">
            <span class="icon">üìß</span>
            Email
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-label"><div class="dot indigo"></div>Download Report</div>
        <div class="download-options">
          <button class="download-btn" onclick="downloadReport('text')">
            <span class="icon">üìÑ</span>
            <div class="info">
              <strong>Text Report</strong>
              <span>Human-readable summary</span>
            </div>
          </button>
          <button class="download-btn" onclick="downloadReport('csv')">
            <span class="icon">üìä</span>
            <div class="info">
              <strong>CSV Spreadsheet</strong>
              <span>For tracking & analysis</span>
            </div>
          </button>
          <button class="download-btn" onclick="downloadReport('json')">
            <span class="icon">üíæ</span>
            <div class="info">
              <strong>Full Backup (JSON)</strong>
              <span>All your data</span>
            </div>
          </button>
        </div>
      </div>
      
      <div class="card" style="background: var(--green-soft); border-color: rgba(34, 197, 94, 0.2);">
        <div style="display: flex; gap: 12px; align-items: flex-start;">
          <span style="font-size: 24px;">üîí</span>
          <div>
            <strong style="font-size: 14px; display: block; margin-bottom: 4px;">Your data is private</strong>
            <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">All data stays on your phone. You choose what to share.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Navigation -->
  <div class="nav">
    <button class="nav-btn active" data-section="today">
      <span class="icon">‚òÄÔ∏è</span>
      <span>Today</span>
    </button>
    <button class="nav-btn" data-section="journey">
      <span class="icon">üìä</span>
      <span>Journey</span>
    </button>
    <button class="nav-btn" data-section="advanced">
      <span class="icon">üß™</span>
      <span>Advanced</span>
    </button>
    <button class="nav-btn" data-section="share">
      <span class="icon">üì§</span>
      <span>Share</span>
    </button>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
  <!-- Edit Modal -->
  <div class="modal-overlay" id="edit-modal">
    <div class="modal">
      <h3 id="modal-title">Edit Log</h3>
      <div class="modal-field">
        <label>Day Number</label>
        <input type="number" id="edit-day" min="1" max="15" readonly>
      </div>
      <div class="modal-field">
        <label>Woke Up At (eyes opened)</label>
        <input type="time" id="edit-wake-time">
      </div>
      <div class="modal-field">
        <label>Got Out of Bed At</label>
        <input type="time" id="edit-out-of-bed-time">
      </div>
      <div class="modal-field">
        <label>Habits Completed (out of 9)</label>
        <input type="number" id="edit-habits" min="0" max="9">
      </div>
      <div class="modal-field">
        <label>Sleep Quality (1-10)</label>
        <input type="number" id="edit-sleep" min="0" max="10">
      </div>
      <div class="modal-field">
        <label>Energy Level (1-10)</label>
        <input type="number" id="edit-energy" min="0" max="10">
      </div>
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeEditModal()">Cancel</button>
        <button class="modal-btn delete" onclick="deleteLog()">Delete</button>
        <button class="modal-btn save" onclick="saveLog()">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Science Modal -->
  <div class="science-modal-overlay" id="science-overlay" onclick="closeScienceModal()"></div>
  <div class="science-modal" id="science-modal">
    <button class="science-modal-close" onclick="closeScienceModal()">√ó</button>
    <div class="science-modal-header">
      <span class="science-modal-icon" id="science-icon">‚òï</span>
      <h3 class="science-modal-title" id="science-title">Topic</h3>
    </div>
    <div class="science-modal-body" id="science-body">
      <!-- Content populated by JS -->
    </div>
  </div>

  <script>
    // ========== THEME ==========
    function toggleTheme() {
      const isDayMode = document.body.classList.toggle('day-mode');
      localStorage.setItem('dawn-theme', isDayMode ? 'day' : 'night');
      updateThemeButton(isDayMode);
    }
    
    function updateThemeButton(isDayMode) {
      document.getElementById('theme-icon').textContent = isDayMode ? 'üåô' : '‚òÄÔ∏è';
      document.getElementById('theme-label').textContent = isDayMode ? 'Night' : 'Day';
    }
    
    function loadTheme() {
      const saved = localStorage.getItem('dawn-theme');
      if (saved) {
        const isDayMode = saved === 'day';
        document.body.classList.toggle('day-mode', isDayMode);
        updateThemeButton(isDayMode);
      } else {
        // Auto-detect based on time of day
        const hour = new Date().getHours();
        const isDayMode = hour >= 6 && hour < 18;
        document.body.classList.toggle('day-mode', isDayMode);
        updateThemeButton(isDayMode);
      }
    }
    
    // ========== LOG EDITING ==========
    let editingDate = null;
    
    function renderLogHistory() {
      const logList = document.getElementById('log-list');
      const entries = Object.entries(state.history).sort().reverse();
      
      if (entries.length === 0) {
        logList.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No logs yet. Complete your first day!</p>';
        return;
      }
      
      logList.innerHTML = entries.map(([date, data]) => {
        const d = new Date(date);
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const habitsCount = Object.values(data.habits || {}).filter(Boolean).length;
        
        // Calculate snooze time
        let snoozeTime = 0;
        if (data.actualWakeTime && data.outOfBedTime) {
          const wake = inputValueToMinutes(data.actualWakeTime);
          const outOfBed = inputValueToMinutes(data.outOfBedTime);
          if (wake !== null && outOfBed !== null) {
            snoozeTime = outOfBed - wake;
          }
        }
        
        // Calculate wake time difference from target
        let wakeStatus = '';
        let wakeColor = 'var(--text-muted)';
        const outOfBedTime = data.outOfBedTime || data.actualWakeTime;
        if (outOfBedTime && data.targetWakeTime) {
          const actual = inputValueToMinutes(outOfBedTime);
          const target = inputValueToMinutes(data.targetWakeTime);
          if (actual !== null && target !== null) {
            const diff = actual - target;
            if (Math.abs(diff) <= 15) {
              wakeStatus = '‚úì';
              wakeColor = 'var(--green)';
            } else if (diff < 0) {
              wakeStatus = `-${Math.abs(diff)}m`;
              wakeColor = 'var(--green)';
            } else {
              wakeStatus = `+${diff}m`;
              wakeColor = 'var(--red)';
            }
          }
        }
        
        // Format times for display
        const wakeDisplay = data.actualWakeTime ? formatTimeFromInput(data.actualWakeTime) : '-';
        const outOfBedDisplay = data.outOfBedTime ? formatTimeFromInput(data.outOfBedTime) : wakeDisplay;
        
        return `
          <div class="log-item" onclick="openEditModal('${date}')">
            <div class="log-date">
              <strong>Day ${data.day || '?'}</strong>
              <span>${dayName}</span>
            </div>
            <div class="log-stats">
              <div class="log-stat">
                <div class="value" style="color: ${wakeColor};">${outOfBedDisplay}</div>
                <div class="label">${wakeStatus || 'Up'}</div>
              </div>
              <div class="log-stat">
                <div class="value" style="color: ${snoozeTime > 10 ? 'var(--orange)' : 'var(--green)'};">${snoozeTime}m</div>
                <div class="label">Snooze</div>
              </div>
              <div class="log-stat">
                <div class="value">${habitsCount}/9</div>
                <div class="label">Habits</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function formatTimeFromInput(timeStr) {
      if (!timeStr) return '-';
      const [h, m] = timeStr.split(':').map(Number);
      const period = h >= 12 ? 'PM' : 'AM';
      const displayH = h > 12 ? h - 12 : (h === 0 ? 12 : h);
      return `${displayH}:${m.toString().padStart(2, '0')}`;
    }
    
    function openEditModal(date) {
      editingDate = date;
      const data = state.history[date];
      
      document.getElementById('modal-title').textContent = `Edit Day ${data.day || '?'}`;
      document.getElementById('edit-day').value = data.day || 1;
      document.getElementById('edit-wake-time').value = data.actualWakeTime || '';
      document.getElementById('edit-out-of-bed-time').value = data.outOfBedTime || data.actualWakeTime || '';
      document.getElementById('edit-habits').value = Object.values(data.habits || {}).filter(Boolean).length;
      document.getElementById('edit-sleep').value = data.sleepQuality || 0;
      document.getElementById('edit-energy').value = data.energyLevel || 0;
      
      document.getElementById('edit-modal').classList.add('show');
    }
    
    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('show');
      editingDate = null;
    }
    
    function saveLog() {
      if (!editingDate) return;
      
      const actualWakeTime = document.getElementById('edit-wake-time').value;
      const outOfBedTime = document.getElementById('edit-out-of-bed-time').value;
      const habitsCount = parseInt(document.getElementById('edit-habits').value) || 0;
      const sleepQuality = parseInt(document.getElementById('edit-sleep').value) || 0;
      const energyLevel = parseInt(document.getElementById('edit-energy').value) || 0;
      
      // Create habits object based on count
      const habits = {};
      HABITS.slice(0, habitsCount).forEach(h => habits[h.id] = true);
      
      state.history[editingDate] = {
        ...state.history[editingDate],
        actualWakeTime: actualWakeTime,
        outOfBedTime: outOfBedTime,
        habits: habits,
        sleepQuality: sleepQuality,
        energyLevel: energyLevel
      };
      
      saveState();
      renderLogHistory();
      updateUI();
      closeEditModal();
      showToast('‚úì Log updated');
    }
    
    function deleteLog() {
      if (!editingDate) return;
      
      const data = state.history[editingDate];
      if (!confirm(`Delete log for Day ${data.day}?`)) return;
      
      delete state.history[editingDate];
      
      // Recalculate current day and streak
      const daysLogged = Object.keys(state.history).length;
      state.currentDay = Math.max(1, daysLogged + 1);
      
      // Recalculate streak
      const sortedDates = Object.keys(state.history).sort().reverse();
      let streak = 0;
      const today = new Date();
      for (let i = 0; i < sortedDates.length; i++) {
        const logDate = new Date(sortedDates[i]);
        const diffDays = Math.floor((today - logDate) / (1000 * 60 * 60 * 24));
        if (diffDays === i || diffDays === i + 1) {
          streak++;
        } else {
          break;
        }
      }
      state.streak = streak;
      
      saveState();
      renderLogHistory();
      renderPhaseTimeline();
      updateUI();
      closeEditModal();
      showToast('‚úì Log deleted');
    }

    // ========== CONFIG ==========
    const CONFIG = {
      startWake: 8 * 60,    // 8:00 AM in minutes
      targetWake: 5 * 60,   // 5:00 AM in minutes
      shiftPerPhase: 36,    // 36 min shift per phase (180 min / 5 phases)
      daysPerPhase: 3,
      totalPhases: 5,       // 5 phases √ó 3 days = 15 days
      sleepDuration: 8 * 60 // 8 hours sleep
    };
    
    const HABITS = [
      { id: 'light', name: 'Morning Light', icon: '‚òÄÔ∏è', time: 'morning', impact: 'critical', desc: 'Get bright light within 30 min of waking' },
      { id: 'no_snooze', name: 'No Snooze', icon: '‚è∞', time: 'morning', impact: 'high', desc: 'Get up at first alarm' },
      { id: 'exercise', name: 'Exercise', icon: 'üèÉ', time: 'morning', impact: 'high', desc: '15-30 min morning activity' },
      { id: 'breakfast', name: 'Early Breakfast', icon: 'üç≥', time: 'morning', impact: 'medium', desc: 'Eat within 1 hour of waking' },
      { id: 'caffeine', name: 'No Late Caffeine', icon: '‚òï', time: 'afternoon', impact: 'high', desc: 'No coffee/tea after 2 PM' },
      { id: 'dinner', name: 'Early Dinner', icon: 'üçΩÔ∏è', time: 'evening', impact: 'medium', desc: 'Finish eating 3h before bed' },
      { id: 'screens', name: 'Screens Off', icon: 'üì±', time: 'evening', impact: 'high', desc: 'No screens 1h before bed' },
      { id: 'dim', name: 'Dim Lights', icon: 'üí°', time: 'evening', impact: 'high', desc: 'Dim all lights 90min before bed' },
      { id: 'cool', name: 'Cool Room', icon: '‚ùÑÔ∏è', time: 'evening', impact: 'medium', desc: 'Bedroom at 18-20¬∞C' }
    ];
    
    const ADVANCED_HABITS = [
      { id: 'adv_caffeine_delay', name: 'Delay Morning Caffeine 90min', icon: '‚òï', desc: 'Wait 90-120min after waking for first coffee', scienceKey: 'caffeine-delay' },
      { id: 'adv_cold', name: 'Cold Exposure AM', icon: 'üßä', desc: '1-3 min cold shower after waking', scienceKey: 'cold-exposure' },
      { id: 'adv_sunset', name: 'Sunset Light Viewing', icon: 'üåÖ', desc: 'Get outside in late afternoon before sunset', scienceKey: 'morning-light' },
      { id: 'adv_bath', name: 'Warm Bath Before Bed', icon: 'üõÅ', desc: '15-20min warm bath 1-2h before sleep', scienceKey: 'temperature' },
      { id: 'adv_no_alcohol', name: 'No Alcohol', icon: 'üç∑', desc: 'Avoid alcohol, especially within 4h of bed', scienceKey: 'alcohol' },
      { id: 'adv_evening_self', name: 'Evening Self Check', icon: 'üß†', desc: 'Recognize evening brain makes poor choices', scienceKey: 'evening-self' }
    ];
    
    const SCIENCE_CONTENT = {
      'caffeine-delay': {
        icon: '‚òï',
        title: 'Why Delay Caffeine 90 Minutes?',
        body: `
          <h4>The Adenosine Problem</h4>
          <p>When you wake up, your body naturally has elevated <strong>adenosine</strong> (the sleepiness molecule) that accumulated overnight. Your body is designed to clear this naturally in the first 90-120 minutes of waking.</p>
          
          <h4>What Caffeine Does</h4>
          <p>Caffeine works by <strong>blocking adenosine receptors</strong>, not by eliminating adenosine. If you drink coffee immediately upon waking:</p>
          <ul>
            <li>The adenosine doesn't get cleared ‚Äî it just gets blocked temporarily</li>
            <li>When caffeine wears off (afternoon), all that adenosine comes flooding back</li>
            <li>This causes the famous "afternoon crash"</li>
          </ul>
          
          <h4>The Protocol</h4>
          <p>Wait 90-120 minutes after waking before your first caffeine. This allows:</p>
          <ul>
            <li>Natural adenosine clearance via cortisol awakening response</li>
            <li>Smoother, more sustained energy throughout the day</li>
            <li>No afternoon crash</li>
          </ul>
          
          <div class="source"><strong>Source:</strong> Dr. Andrew Huberman, Stanford Neuroscience Lab</div>
        `
      },
      'cold-exposure': {
        icon: 'üßä',
        title: 'Morning Cold Exposure',
        body: `
          <h4>The Temperature Wake Signal</h4>
          <p>Your body wakes up when core temperature <strong>rises</strong>. Cold exposure triggers a powerful compensatory heat response that:</p>
          <ul>
            <li>Spikes <strong>norepinephrine</strong> by 200-300% (immediate alertness)</li>
            <li>Increases <strong>dopamine</strong> by 250% (sustained for hours)</li>
            <li>Raises core body temperature</li>
          </ul>
          
          <h4>Circadian Benefit</h4>
          <p>Raising body temperature in the morning helps <strong>anchor your circadian rhythm</strong>. Your body learns that cold = morning = time to be awake. This makes falling asleep easier at night.</p>
          
          <h4>The Protocol</h4>
          <ul>
            <li>End your shower with 30 seconds to 3 minutes of cold water</li>
            <li>Temperature should be uncomfortable but safe</li>
            <li>Best done within first hour of waking</li>
          </ul>
          
          <div class="source"><strong>Source:</strong> Dr. Andrew Huberman, Huberman Lab Podcast</div>
        `
      },
      'evening-self': {
        icon: 'üß†',
        title: 'Evening Self Identity Protocol',
        body: `
          <h4>Bryan Johnson's Discovery</h4>
          <p>Bryan Johnson realized his <strong>evening self</strong> made terrible decisions. Late-night eating, screen time, staying up "just 15 more minutes" ‚Äî all sabotaging his sleep and health.</p>
          
          <h4>The Split Identity Approach</h4>
          <p>Johnson literally <strong>"fired" his evening self</strong> by recognizing it as a separate entity with different motivations:</p>
          <ul>
            <li>"Evening Bryan" wants short-term pleasure</li>
            <li>"Morning Bryan" pays the consequences</li>
            <li>Evening Bryan is persuasive: "Just tonight..." or "You deserve this..."</li>
          </ul>
          
          <h4>The Protocol</h4>
          <ul>
            <li>Recognize that after 7 PM, your willpower is depleted</li>
            <li>Make rules that don't require willpower (e.g., kitchen closes at 6 PM)</li>
            <li>Set up your environment earlier in the day</li>
            <li>When tempted, ask: "Is Evening Me making this decision?"</li>
          </ul>
          
          <div class="source"><strong>Source:</strong> Bryan Johnson, Blueprint Protocol</div>
        `
      },
      'morning-light': {
        icon: '‚òÄÔ∏è',
        title: 'Morning Light (10,000 lux)',
        body: `
          <h4>The Master Clock</h4>
          <p>Your brain has a <strong>suprachiasmatic nucleus (SCN)</strong> ‚Äî the master circadian clock. It sets the timing for every system in your body: hormones, metabolism, alertness, and sleep.</p>
          
          <h4>Why Light Matters</h4>
          <p>The SCN is primarily set by <strong>light entering your eyes</strong>. Specialized cells (melanopsin ganglion cells) respond to bright light, especially at low solar angle (sunrise/sunset).</p>
          <ul>
            <li>Indoor light: 300-500 lux (too dim)</li>
            <li>Overcast day: 10,000+ lux (sufficient)</li>
            <li>Sunny day: 50,000-100,000 lux</li>
          </ul>
          
          <h4>The Protocol</h4>
          <ul>
            <li>Get outside within 30-60 minutes of waking</li>
            <li>10-15 min on sunny days, 20-30 min on cloudy days</li>
            <li>No sunglasses (regular glasses/contacts OK)</li>
            <li>If waking before sunrise, use 10,000 lux light box for 3-5 min</li>
          </ul>
          
          <h4>Evening Light Too</h4>
          <p>A second exposure before sunset signals to your brain that night is coming, preparing melatonin release.</p>
          
          <div class="source"><strong>Sources:</strong> Dr. Andrew Huberman, Dr. Satchin Panda</div>
        `
      },
      'temperature': {
        icon: 'üå°Ô∏è',
        title: 'Temperature & Sleep',
        body: `
          <h4>The 1-3¬∞F Rule</h4>
          <p>Your body <strong>must drop 1-3¬∞F (0.5-1.5¬∞C)</strong> in core temperature to initiate sleep. This is non-negotiable biology.</p>
          
          <h4>Optimal Bedroom Temperature</h4>
          <ul>
            <li>Target: 60-67¬∞F (15-19¬∞C)</li>
            <li>Most people keep rooms too warm</li>
            <li>Cooler is better for deep sleep</li>
          </ul>
          
          <h4>The Warm Bath Paradox</h4>
          <p>A warm bath 1-2 hours before bed <strong>actually helps you cool down</strong>:</p>
          <ul>
            <li>Warm water dilates blood vessels</li>
            <li>Blood flows to skin surface</li>
            <li>When you get out, heat radiates away rapidly</li>
            <li>Core temperature drops faster than normal</li>
          </ul>
          
          <h4>Peter Attia's Protocol</h4>
          <p>15-minute sauna at 198¬∞F, followed by cool-down, 1-2 hours before bed. Reported significant improvements in sleep quality.</p>
          
          <div class="source"><strong>Sources:</strong> Dr. Peter Attia, Dr. Matthew Walker</div>
        `
      },
      'supplements': {
        icon: 'üíä',
        title: 'Sleep Supplements Stack',
        body: `
          <h4>Tier 1: The Foundation (Start Here)</h4>
          <p><strong>Magnesium Threonate (145mg)</strong></p>
          <ul>
            <li>Crosses blood-brain barrier better than other forms</li>
            <li>Promotes relaxation and GABA activity</li>
            <li>Many people are deficient</li>
          </ul>
          
          <p><strong>L-Theanine (100-400mg)</strong></p>
          <ul>
            <li>Promotes calm without sedation</li>
            <li>Found naturally in tea</li>
            <li>Can cause vivid dreams in some people</li>
          </ul>
          
          <h4>Tier 2: Additional Support</h4>
          <p><strong>Apigenin (50mg)</strong></p>
          <ul>
            <li>Derived from chamomile</li>
            <li>Mild sedative effect</li>
            <li>Part of Huberman's stack</li>
          </ul>
          
          <p><strong>Glycine (2-3g)</strong></p>
          <ul>
            <li>Inhibitory neurotransmitter</li>
            <li>Shortens time to fall asleep</li>
            <li>Peter Attia uses this</li>
          </ul>
          
          <h4>Important Notes</h4>
          <ul>
            <li>Start with ONE supplement, add gradually</li>
            <li>Take 30-60 minutes before bed</li>
            <li>Melatonin: use sparingly (0.5-1mg max)</li>
          </ul>
          
          <div class="source"><strong>Sources:</strong> Dr. Andrew Huberman, Dr. Peter Attia</div>
        `
      },
      'alcohol': {
        icon: 'üç∑',
        title: 'Alcohol & Deep Sleep',
        body: `
          <h4>The Neuroscience</h4>
          <p>Alcohol is a <strong>sedative</strong>, not a sleep aid. This distinction is critical. Sedation and natural sleep are neurologically different states.</p>
          
          <h4>How Alcohol Disrupts Sleep Architecture</h4>
          <ul>
            <li><strong>Blocks REM sleep:</strong> Alcohol suppresses rapid eye movement sleep, which is essential for memory consolidation and emotional processing</li>
            <li><strong>Fragments sleep cycles:</strong> Alcohol metabolizes into aldehydes that trigger repeated micro-awakenings (often unremembered)</li>
            <li><strong>Disrupts glymphatic clearance:</strong> The brain's waste-removal system operates during deep sleep; alcohol impairs this detoxification process</li>
            <li><strong>Inhibits vasopressin:</strong> This anti-diuretic hormone gets blocked, causing nighttime urination and dehydration</li>
          </ul>
          
          <h4>Research Findings</h4>
          <p><strong>Bryan Johnson's WHOOP data:</strong> Deep sleep reduced by approximately 80% on nights with alcohol consumption.</p>
          <p><strong>Dr. Matthew Walker's research (UC Berkeley):</strong> Even moderate drinking (2 drinks) several hours before bed significantly reduces sleep quality metrics and next-day cognitive performance.</p>
          <p><strong>2018 JMIR Mental Health study:</strong> Even low alcohol consumption (1-2 drinks) decreased sleep quality by 9.3%; moderate consumption decreased it by 24%; high consumption by 39.2%.</p>
          
          <h4>The Protocol</h4>
          <ul>
            <li>For optimal sleep: eliminate alcohol entirely</li>
            <li>If consuming: limit to 1 drink, finish 4+ hours before bed</li>
            <li>Track with a wearable to see your personal response</li>
          </ul>
          
          <div class="source"><strong>Sources:</strong> Dr. Matthew Walker (Why We Sleep), Bryan Johnson (Blueprint), JMIR Mental Health 2018</div>
        `
      },
      'gratitude': {
        icon: 'üôè',
        title: 'Gratitude & Sleep Quality',
        body: `
          <h4>The Research</h4>
          <p>Multiple studies show that a <strong>gratitude practice before bed</strong> significantly improves sleep quality:</p>
          <ul>
            <li>2009 study: Grateful people slept longer and felt more refreshed</li>
            <li>2011 study: Pre-sleep gratitude reduced time to fall asleep</li>
            <li>Mechanism: Shifts focus from worry to positive thoughts</li>
          </ul>
          
          <h4>Why It Works</h4>
          <p>Anxiety and worry activate the <strong>sympathetic nervous system</strong> (fight or flight). Gratitude activates the <strong>parasympathetic system</strong> (rest and digest).</p>
          <ul>
            <li>Lowers cortisol (stress hormone)</li>
            <li>Increases oxytocin (bonding hormone)</li>
            <li>Reduces rumination (repetitive negative thoughts)</li>
          </ul>
          
          <h4>The Protocol</h4>
          <ul>
            <li>Write 3 things you're grateful for</li>
            <li>Be specific (not just "family" but "my daughter's laugh at dinner")</li>
            <li>Elaborate briefly on WHY you're grateful</li>
            <li>3 minutes is enough ‚Äî consistency beats duration</li>
          </ul>
          
          <div class="source"><strong>Sources:</strong> UC Berkeley Greater Good Science Center, Dr. Robert Emmons</div>
        `
      },
      'five-am-club': {
        icon: 'üåÖ',
        title: 'The Science of Waking at 5AM',
        body: `
          <h4>Why 5AM?</h4>
          <p>Robin Sharma, author of <em>The 5AM Club</em>, spent 20+ years coaching billionaires and elite performers. His key finding: <strong>"The way you begin your day sets up the way you live your day."</strong></p>
          
          <h4>The Neuroscience of Early Rising</h4>
          <ul>
            <li><strong>Prefrontal cortex peaks:</strong> Your brain's CEO (decision-making, focus, willpower) is strongest in the first 2-3 hours after waking</li>
            <li><strong>Willpower is finite:</strong> Research shows willpower depletes throughout the day ("ego depletion"). Morning = full tank</li>
            <li><strong>Zero interruptions:</strong> No emails, calls, or demands at 5AM. You own this time completely</li>
            <li><strong>Cortisol awakening response:</strong> Natural cortisol spike at dawn enhances alertness and focus</li>
          </ul>
          
          <h4>Research Findings</h4>
          <p><strong>University of Toronto:</strong> People make better decisions in the morning hours.</p>
          <p><strong>Harvard sleep researcher Dr. Charles Czeisler:</strong> Consistent sleep schedules improve cognitive performance by 20-30%.</p>
          <p><strong>University College London:</strong> Habits take an average of 66 days to become automatic.</p>
          
          <h4>Famous Early Risers</h4>
          <p>Mozart, Frank Lloyd Wright, Ernest Hemingway, Tim Cook (Apple), and countless elite performers all leveraged the morning hours.</p>
          
          <div class="source"><strong>Sources:</strong> Robin Sharma (The 5AM Club), University of Toronto, Harvard Medical School</div>
        `
      },
      'twenty-twenty-twenty': {
        icon: '‚è±Ô∏è',
        title: 'The 20/20/20 Formula',
        body: `
          <h4>Robin Sharma's Victory Hour</h4>
          <p>The 20/20/20 formula divides your first hour into three powerful 20-minute blocks:</p>
          
          <h4>5:00-5:20 AM ‚Äî MOVE (Exercise)</h4>
          <p>Vigorous exercise to <strong>sweat</strong>. The goal is triggering specific neurochemical changes:</p>
          <ul>
            <li><strong>BDNF release:</strong> Brain-Derived Neurotrophic Factor repairs brain cells and accelerates new neural connections</li>
            <li><strong>Cortisol reduction:</strong> Sweat eliminates the stress hormone</li>
            <li><strong>Dopamine + serotonin:</strong> Boosts mood and inspiration</li>
            <li><strong>Norepinephrine:</strong> Enhances focus and attention</li>
          </ul>
          
          <h4>5:20-5:40 AM ‚Äî REFLECT (Stillness)</h4>
          <p>Meditation, journaling, prayer, or quiet contemplation:</p>
          <ul>
            <li>Activates parasympathetic nervous system</li>
            <li>Increases prefrontal cortex gray matter (Harvard study: 8 weeks of meditation)</li>
            <li>Connects you to your "four interior empires": mindset, heartset, healthset, soulset</li>
          </ul>
          
          <h4>5:40-6:00 AM ‚Äî GROW (Learning)</h4>
          <p>Read, study, review goals, or learn a new skill:</p>
          <ul>
            <li>Morning learning = better retention (hippocampus most receptive)</li>
            <li>1% daily improvement = 365% growth per year (compound effect)</li>
            <li>This is "sharpening the saw" before the world demands your attention</li>
          </ul>
          
          <div class="source"><strong>Source:</strong> Robin Sharma, The 5AM Club: Own Your Morning, Elevate Your Life</div>
        `
      },
      'morning-willpower': {
        icon: 'üß†',
        title: 'Morning Willpower & Productivity',
        body: `
          <h4>The Prefrontal Cortex Advantage</h4>
          <p>Your prefrontal cortex ‚Äî responsible for decision-making, planning, focus, and self-control ‚Äî operates at <strong>peak capacity in the morning</strong>.</p>
          
          <h4>Sleep Inertia: The First 30 Minutes</h4>
          <p>Research shows your brain operates at only <strong>51% capacity</strong> for approximately 30 minutes after waking. This is why:</p>
          <ul>
            <li>Don't make important decisions immediately upon waking</li>
            <li>Use this time for automatic routines (not willpower-heavy tasks)</li>
            <li>Light exposure and movement accelerate the wake-up process</li>
          </ul>
          
          <h4>Ego Depletion: Why Evenings Are Hard</h4>
          <p>Psychologist Roy Baumeister's research shows willpower is a <strong>finite resource</strong> that depletes throughout the day:</p>
          <ul>
            <li>Every decision drains your willpower tank</li>
            <li>By evening, your self-control is at its lowest</li>
            <li>This is why diet failures, impulse purchases, and bad decisions cluster in the evening</li>
          </ul>
          
          <h4>The Implication: "Eat the Frog"</h4>
          <p>Brian Tracy's principle: <strong>Do your hardest task first</strong> (when willpower is highest).</p>
          <ul>
            <li>Writer? Write the hardest section first.</li>
            <li>Developer? Tackle the toughest bug first.</li>
            <li>Student? Study the hardest subject first.</li>
          </ul>
          <p>After your "frog," the rest of the day feels easier.</p>
          
          <div class="source"><strong>Sources:</strong> Roy Baumeister (Willpower), Brian Tracy (Eat That Frog), University of Toronto</div>
        `
      }
    };
    
    // ========== STATE ==========
    let state = {
      currentDay: 1,
      streak: 0,
      habits: {},
      advancedHabits: {},
      sleepQuality: 0,
      energyLevel: 0,
      actualWakeTime: '',
      outOfBedTime: '',
      history: {},
      startDate: null,
      journal: {
        morning: ['', '', ''],
        evening: ['', '', '']
      }
    };
    
    // ========== HELPERS ==========
    function formatTime(minutes) {
      let h = Math.floor(minutes / 60);
      let m = minutes % 60;
      if (h < 0) h += 24;
      if (h >= 24) h -= 24;
      const period = h >= 12 ? 'PM' : 'AM';
      const displayH = h > 12 ? h - 12 : (h === 0 ? 12 : h);
      return `${displayH}:${m.toString().padStart(2, '0')} ${period}`;
    }
    
    function getPhase(day) {
      return Math.min(Math.floor((day - 1) / CONFIG.daysPerPhase), CONFIG.totalPhases - 1);
    }
    
    function getTargetWake(day) {
      const phase = getPhase(day);
      return CONFIG.startWake - (phase * CONFIG.shiftPerPhase);
    }
    
    function getTargetBed(day) {
      return getTargetWake(day) - CONFIG.sleepDuration;
    }
    
    // ========== UI ==========
    function updateUI() {
      const phase = getPhase(state.currentDay);
      const targetWake = getTargetWake(state.currentDay);
      const targetBed = getTargetBed(state.currentDay);
      const shifted = phase * CONFIG.shiftPerPhase;
      
      // Phase banner
      document.getElementById('phase-title').textContent = `Day ${state.currentDay} ‚Ä¢ Phase ${phase + 1}`;
      document.getElementById('phase-subtitle').textContent = `${formatTime(CONFIG.startWake)} ‚Üí ${formatTime(CONFIG.targetWake)}`;
      document.getElementById('streak-count').textContent = state.streak;
      
      // Time targets
      document.getElementById('target-wake').textContent = formatTime(targetWake);
      document.getElementById('target-bed').textContent = formatTime(targetBed);
      
      // Progress
      const completedHabits = Object.values(state.habits).filter(Boolean).length;
      const dailyProgress = Math.round((completedHabits / HABITS.length) * 100);
      
      document.getElementById('completed-count').textContent = completedHabits;
      document.getElementById('daily-percent').textContent = dailyProgress;
      document.getElementById('progress-ring').style.strokeDasharray = `${dailyProgress * 2.64} 264`;
      
      // Update checklist and button
      document.getElementById('summary-day-num').textContent = state.currentDay;
      document.getElementById('complete-btn-text').textContent = `Finish Day ${state.currentDay}`;
      document.getElementById('habits-progress').textContent = completedHabits;
      updateChecklist();
      
      // Alert based on time of day
      updateAlert(targetBed);
      
      // Stats
      document.getElementById('stat-streak').textContent = state.streak;
      document.getElementById('stat-days').textContent = Object.keys(state.history).length;
      document.getElementById('stat-phase').textContent = `${phase + 1}/5`;
      document.getElementById('stat-shifted').textContent = `${shifted}m`;
      
      // Share stats
      document.getElementById('share-day').textContent = state.currentDay;
      document.getElementById('share-shifted').textContent = `${shifted}m`;
      document.getElementById('share-streak').textContent = state.streak;
      document.getElementById('share-target').textContent = formatTime(CONFIG.targetWake);
    }
    
    function updateAlert(targetBed) {
      const hour = new Date().getHours();
      const alert = document.getElementById('time-alert');
      const icon = document.getElementById('alert-icon');
      const title = document.getElementById('alert-title');
      const text = document.getElementById('alert-text');
      
      if (hour >= 5 && hour < 12) {
        alert.className = 'card alert morning';
        icon.textContent = '‚òÄÔ∏è';
        title.textContent = 'Morning Priority';
        text.textContent = 'Get bright light NOW. This is the #1 factor for shifting your rhythm.';
      } else if (hour >= 12 && hour < 17) {
        alert.className = 'card alert afternoon';
        icon.textContent = '‚òï';
        title.textContent = 'Afternoon Reminder';
        text.textContent = 'No more caffeine after 2 PM. Start planning your wind-down routine.';
      } else {
        alert.className = 'card alert evening';
        icon.textContent = 'üåô';
        title.textContent = 'Evening Wind-down';
        const screenOff = targetBed + 60 < 0 ? targetBed + 60 + 1440 : targetBed + 60;
        text.textContent = `Dim your lights. Screen-off time: ${formatTime(screenOff)}. Bedtime: ${formatTime(targetBed)}.`;
      }
    }
    
    function setupWakeTimeInput() {
      const wakeInput = document.getElementById('actual-wake-time');
      const outOfBedInput = document.getElementById('out-of-bed-time');
      
      // Set current values from state
      if (state.actualWakeTime) {
        wakeInput.value = state.actualWakeTime;
      }
      if (state.outOfBedTime) {
        outOfBedInput.value = state.outOfBedTime;
      }
      
      // Handle wake time changes
      wakeInput.addEventListener('change', () => {
        state.actualWakeTime = wakeInput.value;
        // Auto-set out of bed to same time if not set
        if (!state.outOfBedTime && state.actualWakeTime) {
          state.outOfBedTime = state.actualWakeTime;
          outOfBedInput.value = state.actualWakeTime;
        }
        saveState();
        updateWakeComparison();
        updateChecklist();
      });
      
      // Handle out of bed time changes
      outOfBedInput.addEventListener('change', () => {
        state.outOfBedTime = outOfBedInput.value;
        saveState();
        updateWakeComparison();
        updateChecklist();
      });
      
      updateWakeComparison();
      updateChecklist();
    }
    
    function updateWakeComparison() {
      const comparison = document.getElementById('wake-comparison');
      const targetWake = getTargetWake(state.currentDay);
      
      if (!state.actualWakeTime) {
        comparison.className = 'wake-comparison empty';
        comparison.innerHTML = 'Enter your wake time above';
        return;
      }
      
      // Parse times
      const wakeMinutes = inputValueToMinutes(state.actualWakeTime);
      const outOfBedMinutes = state.outOfBedTime ? inputValueToMinutes(state.outOfBedTime) : wakeMinutes;
      
      // Calculate difference from target (use out of bed time as the "real" wake)
      const diff = outOfBedMinutes - targetWake;
      
      // Calculate snooze/linger time
      const snoozeTime = outOfBedMinutes - wakeMinutes;
      
      let statusText = '';
      let statusClass = '';
      
      if (Math.abs(diff) <= 15) {
        statusClass = 'on-target';
        statusText = `‚úì Right on target! Out of bed at ${formatTimeFromInput(state.outOfBedTime || state.actualWakeTime)}`;
      } else if (diff < 0) {
        statusClass = 'early';
        statusText = `‚úì ${Math.abs(diff)} min early! Great job!`;
      } else {
        statusClass = 'late';
        statusText = `${diff} min late. Target was ${formatTime(targetWake)}`;
      }
      
      // Add snooze info if there's a gap
      let snoozeInfo = '';
      if (snoozeTime > 0) {
        if (snoozeTime <= 5) {
          snoozeInfo = `<span class="snooze-time">‚ö° ${snoozeTime} min to get up ‚Äî great discipline!</span>`;
        } else if (snoozeTime <= 15) {
          snoozeInfo = `<span class="snooze-time">‚è∞ ${snoozeTime} min in bed after waking ‚Äî try to reduce this</span>`;
        } else {
          snoozeInfo = `<span class="snooze-time">üò¥ ${snoozeTime} min snooze time ‚Äî this delays your rhythm shift</span>`;
        }
      } else if (state.outOfBedTime) {
        snoozeInfo = `<span class="snooze-time">‚ö° No snooze ‚Äî perfect!</span>`;
      }
      
      comparison.className = `wake-comparison ${statusClass}`;
      comparison.innerHTML = statusText + snoozeInfo;
    }
    
    function timeToInputValue(minutes) {
      if (!minutes && minutes !== 0) return '';
      let h = Math.floor(minutes / 60);
      let m = minutes % 60;
      if (h < 0) h += 24;
      if (h >= 24) h -= 24;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }
    
    function inputValueToMinutes(value) {
      if (!value) return null;
      const [h, m] = value.split(':').map(Number);
      return h * 60 + m;
    }
    
    function updateChecklist() {
      const completedHabits = Object.values(state.habits).filter(Boolean).length;
      const hasWakeTime = !!state.actualWakeTime;
      const hasOutOfBed = !!state.outOfBedTime;
      const hasEnoughHabits = completedHabits >= 6; // 70% of 9 = 6.3
      
      // Update wake time check
      const checkWake = document.getElementById('check-wake');
      if (hasWakeTime) {
        checkWake.classList.add('done');
        checkWake.querySelector('.check-icon').textContent = '‚úì';
      } else {
        checkWake.classList.remove('done');
        checkWake.querySelector('.check-icon').textContent = '‚óã';
      }
      
      // Update out of bed check
      const checkOutOfBed = document.getElementById('check-outofbed');
      if (hasOutOfBed) {
        checkOutOfBed.classList.add('done');
        checkOutOfBed.querySelector('.check-icon').textContent = '‚úì';
      } else {
        checkOutOfBed.classList.remove('done');
        checkOutOfBed.querySelector('.check-icon').textContent = '‚óã';
      }
      
      // Update habits check
      const checkHabits = document.getElementById('check-habits');
      if (hasEnoughHabits) {
        checkHabits.classList.add('done');
        checkHabits.querySelector('.check-icon').textContent = '‚úì';
      } else {
        checkHabits.classList.remove('done');
        checkHabits.querySelector('.check-icon').textContent = '‚óã';
      }
      
      // Update button state
      const allDone = hasWakeTime && hasOutOfBed && hasEnoughHabits;
      const completeBtn = document.getElementById('complete-btn');
      const hint = document.getElementById('complete-hint');
      
      completeBtn.disabled = !allDone;
      
      if (allDone) {
        hint.textContent = '‚úì Ready to submit!';
        hint.classList.add('ready');
      } else {
        const remaining = [];
        if (!hasWakeTime) remaining.push('wake time');
        if (!hasOutOfBed) remaining.push('out-of-bed time');
        if (!hasEnoughHabits) remaining.push(`${6 - completedHabits} more habits`);
        hint.textContent = `Need: ${remaining.join(', ')}`;
        hint.classList.remove('ready');
      }
    }
    
    function renderHabitGrid() {
      const grid = document.getElementById('habit-grid');
      const hour = new Date().getHours();
      
      let relevantHabits;
      if (hour >= 5 && hour < 12) {
        relevantHabits = HABITS.filter(h => h.time === 'morning');
      } else if (hour >= 12 && hour < 17) {
        relevantHabits = [...HABITS.filter(h => h.time === 'morning'), ...HABITS.filter(h => h.time === 'afternoon')];
      } else {
        relevantHabits = HABITS;
      }
      relevantHabits = relevantHabits.slice(0, 6);
      
      grid.innerHTML = relevantHabits.map(h => `
        <button class="habit-btn ${state.habits[h.id] ? 'done' : ''}" data-id="${h.id}">
          <span class="icon">${h.icon}</span>
          <span class="label">${h.name.split(' ')[0]}</span>
        </button>
      `).join('');
      
      grid.querySelectorAll('.habit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          state.habits[id] = !state.habits[id];
          saveState();
          updateUI();
          renderHabitGrid();
        });
      });
    }
    
    function renderRatings() {
      ['sleep', 'energy'].forEach(type => {
        const container = document.getElementById(`${type}-rating`);
        container.innerHTML = Array.from({ length: 10 }, (_, i) => 
          `<button class="rating-btn ${type} ${(type === 'sleep' ? state.sleepQuality : state.energyLevel) >= i + 1 ? 'active' : ''}" data-value="${i + 1}">${i + 1}</button>`
        ).join('');
        
        container.querySelectorAll('.rating-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const value = parseInt(btn.dataset.value);
            if (type === 'sleep') state.sleepQuality = value;
            else state.energyLevel = value;
            saveState();
            renderRatings();
          });
        });
      });
    }
    
    function renderPhaseTimeline() {
      const container = document.getElementById('phase-timeline');
      const currentPhase = getPhase(state.currentDay);
      
      container.innerHTML = Array.from({ length: CONFIG.totalPhases }, (_, i) => {
        const wake = CONFIG.startWake - (i * CONFIG.shiftPerPhase);
        const isComplete = currentPhase > i;
        const isCurrent = currentPhase === i;
        
        return `
          <div class="phase-item ${isComplete ? 'complete' : ''} ${isCurrent ? 'current' : ''}">
            <div class="phase-num">${isComplete ? '‚úì' : i + 1}</div>
            <div class="phase-details">
              <h4>Wake at ${formatTime(wake)}</h4>
              <p>Days ${i * 3 + 1}-${(i + 1) * 3}</p>
            </div>
            ${isCurrent ? '<span class="phase-badge">NOW</span>' : ''}
          </div>
        `;
      }).join('');
    }
    
    // ========== EVENTS ==========
    function bindEvents() {
      // Navigation
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`${btn.dataset.section}-section`).classList.add('active');
        });
      });
      
      // Complete day
      document.getElementById('complete-btn').addEventListener('click', completeDay);
    }
    
    function completeDay() {
      const completedHabits = Object.values(state.habits).filter(Boolean).length;
      
      // Double-check requirements (button should be disabled if not met)
      if (!state.actualWakeTime || !state.outOfBedTime || completedHabits < 6) {
        showToast('‚ö†Ô∏è Complete the checklist first!');
        return;
      }
      
      const today = new Date().toISOString().split('T')[0];
      state.history[today] = {
        habits: { ...state.habits },
        sleepQuality: state.sleepQuality,
        energyLevel: state.energyLevel,
        actualWakeTime: state.actualWakeTime,
        outOfBedTime: state.outOfBedTime,
        targetWakeTime: timeToInputValue(getTargetWake(state.currentDay)),
        day: state.currentDay,
        phase: getPhase(state.currentDay)
      };
      
      // Update streak based on habit completion
      const dailyProgress = Math.round((completedHabits / HABITS.length) * 100);
      if (dailyProgress >= 70) {
        state.streak++;
      } else {
        state.streak = 0;
      }
      
      const finishedDay = state.currentDay;
      state.currentDay = Math.min(state.currentDay + 1, 15);
      state.habits = {};
      state.sleepQuality = 0;
      state.energyLevel = 0;
      state.actualWakeTime = '';
      state.outOfBedTime = '';
      
      // Reset inputs
      document.getElementById('actual-wake-time').value = '';
      document.getElementById('out-of-bed-time').value = '';
      
      saveState();
      updateUI();
      renderHabitGrid();
      renderRatings();
      renderPhaseTimeline();
      renderLogHistory();
      updateWakeComparison();
      updateChecklist();
      
      if (state.currentDay > 15) {
        showToast('üéâ Congratulations! You completed the 5am Club!');
      } else {
        showToast(`‚úì Day ${finishedDay} complete! Starting Day ${state.currentDay}`);
      }
    }
    
    // ========== EXPORT ==========
    function generateTextReport() {
      const phase = getPhase(state.currentDay);
      const shifted = phase * CONFIG.shiftPerPhase;
      const daysLogged = Object.keys(state.history).length;
      
      let report = `‚òÄÔ∏è DAWN - 5AM CLUB PROGRESS\n`;
      report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
      report += `üìÖ Day ${state.currentDay} of 15\n`;
      report += `üéØ Phase ${phase + 1} of 5\n`;
      report += `‚è∞ Current target: Wake at ${formatTime(getTargetWake(state.currentDay))}\n\n`;
      
      report += `üìä STATS\n`;
      report += `‚Ä¢ Time shifted: ${shifted} minutes\n`;
      report += `‚Ä¢ Day streak: ${state.streak}\n`;
      report += `‚Ä¢ Days logged: ${daysLogged}\n\n`;
      
      report += `üìà WAKE TIME LOG\n`;
      const recentDays = Object.entries(state.history).slice(-7);
      recentDays.forEach(([date, data]) => {
        const habitsCount = Object.values(data.habits || {}).filter(Boolean).length;
        const wakeTime = data.actualWakeTime ? formatTimeFromInput(data.actualWakeTime) : '-';
        const outOfBed = data.outOfBedTime ? formatTimeFromInput(data.outOfBedTime) : wakeTime;
        const target = data.targetWakeTime ? formatTimeFromInput(data.targetWakeTime) : '-';
        
        // Calculate snooze
        let snooze = 0;
        if (data.actualWakeTime && data.outOfBedTime) {
          snooze = inputValueToMinutes(data.outOfBedTime) - inputValueToMinutes(data.actualWakeTime);
        }
        
        report += `‚Ä¢ ${date}: Woke ${wakeTime}, Up ${outOfBed} (${snooze}m snooze), Target ${target}\n`;
      });
      
      report += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      report += `Goal: Wake at 5:00 AM\n`;
      report += `Generated by Dawn - 5am Club Tracker`;
      
      return report;
    }
    
    function generateCSV() {
      let csv = 'Date,Day,Phase,Woke Up,Out of Bed,Target,Diff (min),Snooze (min),Habits,Sleep,Energy\n';
      
      Object.entries(state.history).sort().forEach(([date, data]) => {
        const habitsCount = Object.values(data.habits || {}).filter(Boolean).length;
        const actualWake = data.actualWakeTime || '';
        const outOfBed = data.outOfBedTime || actualWake;
        const targetWake = data.targetWakeTime || '';
        
        // Calculate diff (from out of bed time)
        let diff = '';
        if (outOfBed && targetWake) {
          const actual = inputValueToMinutes(outOfBed);
          const target = inputValueToMinutes(targetWake);
          if (actual !== null && target !== null) {
            diff = actual - target;
          }
        }
        
        // Calculate snooze
        let snooze = '';
        if (actualWake && outOfBed) {
          const wake = inputValueToMinutes(actualWake);
          const up = inputValueToMinutes(outOfBed);
          if (wake !== null && up !== null) {
            snooze = up - wake;
          }
        }
        
        csv += `${date},${data.day || ''},${(data.phase || 0) + 1},${actualWake},${outOfBed},${targetWake},${diff},${snooze},${habitsCount},${data.sleepQuality || ''},${data.energyLevel || ''}\n`;
      });
      
      return csv;
    }
    
    function generateJSON() {
      return JSON.stringify({
        exportDate: new Date().toISOString(),
        app: 'Dawn - 5am Club',
        currentState: {
          day: state.currentDay,
          phase: getPhase(state.currentDay) + 1,
          streak: state.streak,
          targetWake: formatTime(getTargetWake(state.currentDay)),
          shifted: getPhase(state.currentDay) * CONFIG.shiftPerPhase
        },
        history: state.history,
        startDate: state.startDate
      }, null, 2);
    }
    
    function exportToWhatsApp() {
      const report = generateTextReport();
      const encoded = encodeURIComponent(report);
      
      if (navigator.share) {
        navigator.share({ title: 'Dawn Progress Report', text: report }).catch(() => {
          window.open(`https://wa.me/?text=${encoded}`, '_blank');
        });
      } else {
        window.open(`https://wa.me/?text=${encoded}`, '_blank');
      }
      showToast('Opening WhatsApp...');
    }
    
    function exportToEmail() {
      const report = generateTextReport();
      const subject = encodeURIComponent(`Dawn 5am Club Progress - Day ${state.currentDay}`);
      const body = encodeURIComponent(report);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
      showToast('Opening email...');
    }
    
    function downloadReport(format) {
      let content, filename, mimeType;
      
      switch(format) {
        case 'csv':
          content = generateCSV();
          filename = `dawn-progress-${new Date().toISOString().split('T')[0]}.csv`;
          mimeType = 'text/csv';
          break;
        case 'json':
          content = generateJSON();
          filename = `dawn-backup-${new Date().toISOString().split('T')[0]}.json`;
          mimeType = 'application/json';
          break;
        default:
          content = generateTextReport();
          filename = `dawn-report-day${state.currentDay}.txt`;
          mimeType = 'text/plain';
      }
      
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('‚úì Downloaded!');
    }
    
    // ========== STORAGE ==========
    function saveState() {
      try { localStorage.setItem('dawn-5am', JSON.stringify(state)); } catch(e) {}
    }
    
    function loadState() {
      try {
        const saved = localStorage.getItem('dawn-5am');
        if (saved) state = { ...state, ...JSON.parse(saved) };
        if (!state.startDate) state.startDate = new Date().toISOString().split('T')[0];
        if (!state.advancedHabits) state.advancedHabits = {};
        if (!state.journal) state.journal = {};
      } catch(e) {}
    }
    
    // ========== PWA ==========
    let deferredPrompt;
    
    function checkInstall() {
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('install-banner').classList.remove('hidden');
      });
      
      document.getElementById('install-btn').addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            document.getElementById('install-banner').classList.add('hidden');
          }
          deferredPrompt = null;
        } else {
          showToast('Tap Share ‚Üí Add to Home Screen');
        }
      });
      
      document.getElementById('install-close').addEventListener('click', () => {
        document.getElementById('install-banner').classList.add('hidden');
      });
      
      if (window.matchMedia('(display-mode: standalone)').matches) {
        document.getElementById('install-banner').classList.add('hidden');
      }
    }
    
    function registerSW() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('dawn-sw.js').catch(() => {});
      }
    }
    
    // ========== TOAST ==========
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }
    
    // ========== ADVANCED TAB FUNCTIONS ==========
    
    function renderAdvancedHabits() {
      const grid = document.getElementById('advanced-habits-grid');
      if (!grid) return;
      
      grid.innerHTML = ADVANCED_HABITS.map(habit => {
        const isDone = state.advancedHabits[habit.id];
        return `
          <div class="advanced-habit ${isDone ? 'done' : ''}" onclick="toggleAdvancedHabit('${habit.id}')">
            <div class="habit-check">${isDone ? '‚úì' : ''}</div>
            <div class="habit-content">
              <div class="habit-name">${habit.icon} ${habit.name}</div>
              <div class="habit-desc">${habit.desc}</div>
            </div>
            <button class="habit-info-btn" onclick="event.stopPropagation(); showScience('${habit.scienceKey}')">?</button>
          </div>
        `;
      }).join('');
    }
    
    function toggleAdvancedHabit(id) {
      state.advancedHabits[id] = !state.advancedHabits[id];
      saveState();
      renderAdvancedHabits();
    }
    
    // ========== GRATITUDE JOURNAL ==========
    
    function initJournalTab() {
      // Auto-select tab based on time of day
      // Morning: 5am - 12pm, Evening: 12pm onwards
      const hour = new Date().getHours();
      const tab = (hour >= 5 && hour < 12) ? 'morning' : 'evening';
      showJournalTab(tab);
    }
    
    function showJournalTab(tab) {
      // Update tabs
      document.getElementById('morning-tab').classList.remove('active');
      document.getElementById('evening-tab').classList.remove('active');
      document.getElementById(`${tab}-tab`).classList.add('active');
      
      // Update content
      document.getElementById('morning-journal').style.display = tab === 'morning' ? 'block' : 'none';
      document.getElementById('evening-journal').style.display = tab === 'evening' ? 'block' : 'none';
    }
    
    function loadJournal() {
      const today = new Date().toISOString().split('T')[0];
      const todayJournal = state.journal[today] || { morning: ['', '', ''], evening: ['', '', ''] };
      
      // Load morning entries
      for (let i = 1; i <= 3; i++) {
        const el = document.getElementById(`morning-gratitude-${i}`);
        if (el) el.value = todayJournal.morning[i-1] || '';
      }
      
      // Load evening entries
      for (let i = 1; i <= 3; i++) {
        const el = document.getElementById(`evening-gratitude-${i}`);
        if (el) el.value = todayJournal.evening[i-1] || '';
      }
    }
    
    function saveJournal(timeOfDay) {
      const today = new Date().toISOString().split('T')[0];
      
      if (!state.journal[today]) {
        state.journal[today] = { morning: ['', '', ''], evening: ['', '', ''] };
      }
      
      const entries = [];
      for (let i = 1; i <= 3; i++) {
        const el = document.getElementById(`${timeOfDay}-gratitude-${i}`);
        entries.push(el ? el.value : '');
      }
      
      state.journal[today][timeOfDay] = entries;
      saveState();
      showToast(`‚úì ${timeOfDay.charAt(0).toUpperCase() + timeOfDay.slice(1)} journal saved`);
    }
    
    // ========== SCIENCE MODAL ==========
    
    function showScience(key) {
      const content = SCIENCE_CONTENT[key];
      if (!content) return;
      
      document.getElementById('science-icon').textContent = content.icon;
      document.getElementById('science-title').textContent = content.title;
      document.getElementById('science-body').innerHTML = content.body;
      
      document.getElementById('science-overlay').classList.add('show');
      document.getElementById('science-modal').classList.add('show');
    }
    
    function closeScienceModal() {
      document.getElementById('science-overlay').classList.remove('show');
      document.getElementById('science-modal').classList.remove('show');
    }
    
    // ========== INIT ==========
    function init() {
      loadTheme();
      loadState();
      updateUI();
      renderHabitGrid();
      renderRatings();
      renderPhaseTimeline();
      renderLogHistory();
      renderAdvancedHabits();
      loadJournal();
      initJournalTab();
      setupWakeTimeInput();
      bindEvents();
      checkInstall();
      registerSW();
    }
    
    init();
  </script>
</body>
</html>
